const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/BxdCQJyt.js","../chunks/CekVB0OK.js","../chunks/PWCouxKx.js"])))=>i.map(i=>d[i]);
import{i as L,_ as sr}from"../chunks/CekVB0OK.js";import"../chunks/DsnmJJEf.js";import{i as lr}from"../chunks/CqDdcZic.js";import{s as He,h as Q,ah as Re,e as pt,a as ka,b as cr,t as e,X as ur,r as vr,H as dr,c as rt,d as ma,k as ye,ai as mt,aj as fr,f as Aa,i as pr,g as Ae,ak as _t,al as Ma,ac as A,am as nt,j as ht,p as mr,an as _r,ao as _a,ap as gt,aq as hr,ar as gr,as as yt,at as yr,au as br,av as wr,$ as bt,B as z,aw as xr,ax as Er,ay as kr,az as it,aA as Ar,aB as Ta,P as Sr,aC as Mr,aD as Tr,aE as Dr,aF as Or,aG as Rr,aH as Ir,aI as Cr,aJ as Lr,aK as Nr,aL as jr,n as Se,Q as wt,aM as qr,y as Pr,K as Ur,aN as ot,aO as Gr,z as I,A as X,F as f,I as m,aP as Y,C as g,D as zr,J as B,Z as t,G as d,O as $r,aQ as ha,ae as Hr,M as ce,ag as st}from"../chunks/PWCouxKx.js";function Fr(a,i){return i}function Br(a,i,r){for(var s=a.items,l=[],c=i.length,u=0;u<c;u++)yr(i[u].e,l,!0);var y=c>0&&l.length===0&&r!==null;if(y){var E=r.parentNode;br(E),E.append(r),s.clear(),ue(a,i[0].prev,i[c-1].next)}wr(l,()=>{for(var p=0;p<c;p++){var w=i[p];y||(s.delete(w.k),ue(a,w.prev,w.next)),gt(w.e,!y)}})}function Jr(a,i,r,s,l,c=null){var u=a,y={flags:i,items:new Map,first:null};{var E=a;u=Q?He(Re(E)):E.appendChild(pt())}Q&&ka();var p=null,w=!1,D=new Map,h=ur(()=>{var N=r();return Ma(N)?N:N==null?[]:_t(N)}),O,x;function _(){Vr(x,O,y,D,u,l,i,s,r),c!==null&&(O.length===0?p?ht(p):p=Aa(()=>c(u)):p!==null&&mr(p,()=>{p=null}))}cr(()=>{x??=bt,O=e(h);var N=O.length;if(w&&N===0)return;w=N===0;let Z=!1;if(Q){var H=vr(u)===dr;H!==(N===0)&&(u=rt(),He(u),ma(!1),Z=!0)}if(Q){for(var R=null,V,q=0;q<N;q++){if(ye.nodeType===mt&&ye.data===fr){u=ye,Z=!0,ma(!1);break}var re=O[q],K=s(re,q);V=Sa(ye,y,R,null,re,K,q,l,i,r),y.items.set(K,V),R=V}N>0&&He(rt())}if(Q)N===0&&c&&(p=Aa(()=>c(u)));else if(pr()){var te=new Set,W=Ae;for(q=0;q<N;q+=1){re=O[q],K=s(re,q);var oe=y.items.get(K)??D.get(K);oe||(V=Sa(null,y,null,null,re,K,q,l,i,r,!0),D.set(K,V)),te.add(K)}for(const[me,_e]of y.items)te.has(me)||W.skipped_effects.add(_e.e);W.add_callback(_)}else _();Z&&ma(!0),e(h)}),Q&&(u=ye)}function Vr(a,i,r,s,l,c,u,y,E){var p=i.length,w=r.items,D=r.first,h=D,O,x=null,_=[],N=[],Z,H,R,V;for(V=0;V<p;V+=1){if(Z=i[V],H=y(Z,V),R=w.get(H),R===void 0){var q=s.get(H);if(q!==void 0){s.delete(H),w.set(H,q);var re=x?x.next:h;ue(r,x,q),ue(r,q,re),ga(q,re,l),x=q}else{var K=h?h.e.nodes_start:l;x=Sa(K,r,x,x===null?r.first:x.next,Z,H,V,c,u,E)}w.set(H,x),_=[],N=[],h=x.next;continue}if((R.e.f&_a)!==0&&ht(R.e),R!==h){if(O!==void 0&&O.has(R)){if(_.length<N.length){var te=N[0],W;x=te.prev;var oe=_[0],me=_[_.length-1];for(W=0;W<_.length;W+=1)ga(_[W],te,l);for(W=0;W<N.length;W+=1)O.delete(N[W]);ue(r,oe.prev,me.next),ue(r,x,oe),ue(r,me,te),h=te,x=me,V-=1,_=[],N=[]}else O.delete(R),ga(R,h,l),ue(r,R.prev,R.next),ue(r,R,x===null?r.first:x.next),ue(r,x,R),x=R;continue}for(_=[],N=[];h!==null&&h.k!==H;)(h.e.f&_a)===0&&(O??=new Set).add(h),N.push(h),h=h.next;if(h===null)continue;R=h}_.push(R),x=R,h=R.next}if(h!==null||O!==void 0){for(var _e=O===void 0?[]:_t(O);h!==null;)(h.e.f&_a)===0&&_e.push(h),h=h.next;var be=_e.length;if(be>0){var ne=p===0?l:null;Br(r,_e,ne)}}a.first=r.first&&r.first.e,a.last=x&&x.e;for(var J of s.values())gt(J.e);s.clear()}function Sa(a,i,r,s,l,c,u,y,E,p,w){var D=(E&hr)!==0,h=(E&gr)===0,O=D?h?A(l,!1,!1):nt(l):l,x=(E&_r)===0?u:nt(u),_={i:x,v:O,k:c,a:null,e:null,prev:r,next:s};try{if(a===null){var N=document.createDocumentFragment();N.append(a=pt())}return _.e=Aa(()=>y(a,O,x,p),Q),_.e.prev=r&&r.e,_.e.next=s&&s.e,r===null?w||(i.first=_):(r.next=_,r.e.next=_.e),s!==null&&(s.prev=_,s.e.prev=_.e),_}finally{}}function ga(a,i,r){for(var s=a.next?a.next.e.nodes_start:r,l=i?i.e.nodes_start:r,c=a.e.nodes_start;c!==null&&c!==s;){var u=yt(c);l.before(c),c=u}}function ue(a,i,r){i===null?a.first=r:(i.next=r,i.e.next=r&&r.e),r!==null&&(r.prev=i,r.e.prev=i&&i.e)}function Wr(a,i,r=!1,s=!1,l=!1){var c=a,u="";z(()=>{var y=bt;if(u===(u=i()??"")){Q&&ka();return}if(y.nodes_start!==null&&(xr(y.nodes_start,y.nodes_end),y.nodes_start=y.nodes_end=null),u!==""){if(Q){ye.data;for(var E=ka(),p=E;E!==null&&(E.nodeType!==mt||E.data!=="");)p=E,E=yt(E);if(E===null)throw Er(),kr;it(ye,p),c=He(E);return}var w=u+"";r?w=`<svg>${w}</svg>`:s&&(w=`<math>${w}</math>`);var D=Ar(w);if((r||s)&&(D=Re(D)),it(Re(D),D.lastChild),r||s)for(;Re(D);)c.before(Re(D));else c.before(D)}})}const lt=[...` 	
\r\f \v\uFEFF`];function Xr(a,i,r){var s=a==null?"":""+a;if(r){for(var l in r)if(r[l])s=s?s+" "+l:l;else if(s.length)for(var c=l.length,u=0;(u=s.indexOf(l,u))>=0;){var y=u+c;(u===0||lt.includes(s[u-1]))&&(y===s.length||lt.includes(s[y]))?s=(u===0?"":s.substring(0,u))+s.substring(y+1):u=y}}return s===""?null:s}function ct(a,i=!1){var r=i?" !important;":";",s="";for(var l in a){var c=a[l];c!=null&&c!==""&&(s+=" "+l+": "+c+r)}return s}function ya(a){return a[0]!=="-"||a[1]!=="-"?a.toLowerCase():a}function Yr(a,i){if(i){var r="",s,l;if(Array.isArray(i)?(s=i[0],l=i[1]):s=i,a){a=String(a).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var c=!1,u=0,y=!1,E=[];s&&E.push(...Object.keys(s).map(ya)),l&&E.push(...Object.keys(l).map(ya));var p=0,w=-1;const _=a.length;for(var D=0;D<_;D++){var h=a[D];if(y?h==="/"&&a[D-1]==="*"&&(y=!1):c?c===h&&(c=!1):h==="/"&&a[D+1]==="*"?y=!0:h==='"'||h==="'"?c=h:h==="("?u++:h===")"&&u--,!y&&c===!1&&u===0){if(h===":"&&w===-1)w=D;else if(h===";"||D===_-1){if(w!==-1){var O=ya(a.substring(p,w).trim());if(!E.includes(O)){h!==";"&&D++;var x=a.substring(p,D).trim();r+=" "+x+";"}}p=D+1,w=-1}}}}return s&&(r+=ct(s)),l&&(r+=ct(l,!0)),r=r.trim(),r===""?null:r}return a==null?null:String(a)}function ut(a,i,r,s,l,c){var u=a.__className;if(Q||u!==r||u===void 0){var y=Xr(r,s,c);(!Q||y!==a.getAttribute("class"))&&(y==null?a.removeAttribute("class"):a.className=y),a.__className=r}else if(c&&l!==c)for(var E in c){var p=!!c[E];(l==null||p!==!!l[E])&&a.classList.toggle(E,p)}return c}function ba(a,i={},r,s){for(var l in r){var c=r[l];i[l]!==c&&(r[l]==null?a.style.removeProperty(l):a.style.setProperty(l,c,s))}}function Oe(a,i,r,s){var l=a.__style;if(Q||l!==i){var c=Yr(i,s);(!Q||c!==a.getAttribute("style"))&&(c==null?a.removeAttribute("style"):a.style.cssText=c),a.__style=i}else s&&(Array.isArray(s)?(ba(a,r?.[0],s[0]),ba(a,r?.[1],s[1],"important")):ba(a,r,s));return s}function xt(a,i,r=!1){if(a.multiple){if(i==null)return;if(!Ma(i))return Tr();for(var s of a.options)s.selected=i.includes(Ie(s));return}for(s of a.options){var l=Ie(s);if(Dr(l,i)){s.selected=!0;return}}(!r||i!==void 0)&&(a.selectedIndex=-1)}function Kr(a){var i=new MutationObserver(()=>{xt(a,a.__value)});i.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Mr(()=>{i.disconnect()})}function wa(a,i,r=i){var s=!0;Ta(a,"change",l=>{var c=l?"[selected]":":checked",u;if(a.multiple)u=[].map.call(a.querySelectorAll(c),Ie);else{var y=a.querySelector(c)??a.querySelector("option:not([disabled])");u=y&&Ie(y)}r(u)}),Sr(()=>{var l=i();if(xt(a,l,s),s&&l===void 0){var c=a.querySelector(":checked");c!==null&&(l=Ie(c),r(l))}a.__value=l,s=!1}),Kr(a)}function Ie(a){return"__value"in a?a.__value:a.value}const Qr=Symbol("is custom element"),Zr=Symbol("is html");function $e(a){if(Q){var i=!1,r=()=>{if(!i){if(i=!0,a.hasAttribute("value")){var s=a.value;Ce(a,"value",null),a.value=s}if(a.hasAttribute("checked")){var l=a.checked;Ce(a,"checked",null),a.checked=l}}};a.__on_r=r,Cr(r),Lr()}}function Ce(a,i,r,s){var l=en(a);Q&&(l[i]=a.getAttribute(i),i==="src"||i==="srcset"||i==="href"&&a.nodeName==="LINK")||l[i]!==(l[i]=r)&&(i==="loading"&&(a[Nr]=r),r==null?a.removeAttribute(i):typeof r!="string"&&an(a).includes(i)?a[i]=r:a.setAttribute(i,r))}function en(a){return a.__attributes??={[Qr]:a.nodeName.includes("-"),[Zr]:a.namespaceURI===Or}}var vt=new Map;function an(a){var i=vt.get(a.nodeName);if(i)return i;vt.set(a.nodeName,i=[]);for(var r,s=a,l=Element.prototype;l!==s;){r=Ir(s);for(var c in r)r[c].set&&i.push(c);s=Rr(s)}return i}function dt(a,i,r=i){var s=jr(),l=new WeakSet;Ta(a,"input",c=>{var u=c?a.defaultValue:a.value;if(u=xa(a)?Ea(u):u,r(u),Ae!==null&&l.add(Ae),s&&u!==(u=i())){var y=a.selectionStart,E=a.selectionEnd;a.value=u??"",E!==null&&(a.selectionStart=y,a.selectionEnd=Math.min(E,a.value.length))}}),(Q&&a.defaultValue!==a.value||Se(i)==null&&a.value)&&(r(xa(a)?Ea(a.value):a.value),Ae!==null&&l.add(Ae)),wt(()=>{var c=i();if(a===document.activeElement){var u=qr??Ae;if(l.has(u))return}xa(a)&&c===Ea(a.value)||a.type==="date"&&!c&&!a.value||c!==a.value&&(a.value=c??"")})}function ft(a,i,r=i){Ta(a,"change",s=>{var l=s?a.defaultChecked:a.checked;r(l)}),(Q&&a.defaultChecked!==a.checked||Se(i)==null)&&r(a.checked),wt(()=>{var s=i();a.checked=!!s})}function xa(a){var i=a.type;return i==="number"||i==="range"}function Ea(a){return a===""?null:+a}function tn(a){return function(...i){var r=i[0];return r.stopPropagation(),a?.apply(this,i)}}function rn(a){return function(...i){var r=i[0];return r.preventDefault(),a?.apply(this,i)}}function nn(a,i){var r=a.$$events?.[i.type],s=Ma(r)?r.slice():r==null?[]:[r];for(var l of s)l.call(this,i)}var on=I('<span style="color:#d32f2f;"> </span>'),sn=I('<div style="margin-top:18px;"><a class="button primary" target="_blank" rel="noopener noreferrer"><span class="mif-google"></span> Se connecter avec Gmail</a></div>'),ln=I('<div class="overlay-fullscreen-block-ui"><div class="overlay-content-loader"><div style="margin-top:14px;font-size:1.19em;font-weight:500;">Connexion à Gmail requise<br/> <span style="font-size:1em;font-weight:400;"><!></span> <!></div></div></div>'),cn=I("Génération du rapport...<br/><b> </b>",1),un=I('<span style="color:#d32f2f;"> </span>'),vn=I("<span>Merci de patienter...</span>"),dn=I('<div class="overlay-block-ui"><div class="overlay-content-loader"><div data-role="activity" data-type="metro" data-style="color"></div> <div style="margin-top:14px;"><!></div></div></div>'),fn=I('<span style="font-size:0.6em;color:#137ee3;padding-left:0.7em;"> </span>'),pn=I('<span data-role="activity" data-type="metro" data-style="color" style="margin-right:6px;"></span>'),mn=I('<span class="mif-checkmark fg-green" style="margin-right:6px;"></span>'),_n=I('<div class="overlay-fullscreen-block-ui"><div class="overlay-content-loader"><span style="margin-left:12px; color:#1976d2; font-weight:500;"><!> </span></div></div>'),hn=I('<button class="button alert" style="margin-left:18px;min-width:160px;"><span class="mif-exit"></span> Déconnecter Gmail</button> <!>',1),gn=I('<span class="count-loader" style="display:inline-flex;align-items:center;gap:10px;"><span>Comptage...</span> <div data-role="activity" data-type="square" data-style="color" style="width:24px;height:24px;"></div></span>'),yn=I('<span class="fade-in fg-red"> </span>'),bn=I('<span class="fade-in fg-red">Aucun mail trouvé</span>'),wn=I('<span class="fade-in fg-cyan"> </span>'),xn=I("&nbsp;: <b> </b>",1),En=I('<span class="mif-rocket mif-lg"></span> <!>',1),kn=I('<span class="mif-checkmark fg-green" style="font-size:1.13em;vertical-align:middle;margin-right:8px;"></span> ',1),An=I('<span class="mif-cross fg-red" style="font-size:1.3em;vertical-align:middle;margin-right:8px;"></span> ',1),Sn=I('<div><div style="display:flex; align-items:center; min-height:36px;"><span><!></span></div></div>'),Mn=I('<div style="margin-top: 16px;"><a target="_blank" class="button secondary">📄 Voir le résumé dans le navigateur</a></div>'),Tn=I("<option> </option>"),Dn=I('<select style="width:90px;margin-left:10px;"></select>'),On=I('<select style="width:90px;margin-left:10px;"><option>1 min</option><option>5 min</option><option>10 min</option><option>15 min</option><option>30 min</option></select>'),Rn=I(`<button class="button alert metro-btn" type="button" style="margin-left:10px;" title="Désactiver l'automatisation"><span class="mif-stop"></span> Désactiver</button>`),In=I('<br/><span style="color:#137ee3;"> </span>',1),Cn=I('<div style="color:#c0392b;"> </div>'),Ln=I('<div id="rapport-modal-html"><!></div>'),Nn=I("<div>Chargement...</div>"),jn=I(`<div class="overlay-fullscreen-block-ui" style="z-index:3000;" tabindex="0" role="button"><div class="metro-container modal-scroll" style="
				max-width: 900px;
				max-height: 90vh;
				overflow: auto;
				margin: 40px auto;
				background: #fff;
				border-radius: 14px;
				padding: 28px 20px;
				box-shadow: 0 2px 18px #0003;
				position: relative;" role="dialog" tabindex="0" aria-modal="true"><button class="button mini cycle bg-light fg-dark" style="float:right;" type="button" aria-label="Fermer le rapport"><span class="mif-cross"></span></button> <h3>Dernier rapport généré</h3> <button class="button primary metro-btn" type="button" style="margin-bottom:16px;"><span class="mif-file-pdf"></span> Télécharger en PDF</button> <!></div></div>`),qn=I(`<!> <!> <div data-role="activity" style="display:none;"></div> <div><!> <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;"><button class="button bg-indigo fg-white cycle" title="Infos utilisateur" aria-label="Afficher les informations utilisateur"><span class="mif-help1 mif-lg"></span></button> <div style="flex: 1; text-align: center;"><span class="fg-cyan" style="font-size: 1.6em; font-weight: 600;">Résumé Gmail <!></span> <span class="icon mif-mail fg-cyan"></span></div> <!></div> <form><div class="form-group"><label for="input-date">Date à analyser</label> <input type="date" style="width:200px;"/></div> <div id="nb-mails" style="margin-left:8px;font-size:0.97em;color:#555;min-height:28px;"><!></div> <div class="container-fluid p-5 border border-4 bd-grayWhite mt-3 mb-3"><h4>Rapport</h4> <div style="display:flex;justify-content:space-between;gap:20px;"><div style="width:50%;"><label class="switch"><input type="checkbox"/> <span class="check"></span> <span class="caption"> </span></label></div> <div style="width:50%;"><label class="switch"><input type="checkbox"/> <span class="check"></span> <span class="caption"> </span></label></div></div> <div style="display:flex;justify-content:space-between;gap:20px;"><div style="width:50%;"><button class="button success metro-btn mt-2" type="submit"><span class="mif-rocket"></span> </button></div> <div style="width:50%;"><button class="button primary metro-btn mt-2" type="button" title="Envoyer le rapport par email" aria-label="Envoyer le rapport par email" style="min-width:170px;"><span class="mif-mail"></span> </button></div></div> <span class="status-msg"><!></span> <!></div></form> <div class="container-fluid p-5 border border-4 bd-grayWhite mt-3 mb-3"><div class="mt-2"><h4>Automatisation</h4> <span style="font-size:0.95em;margin-left:10px;color:#1a73e8;"> </span> <div class="form-group"><select><option>Aucune</option><option>1 fois par jour (7h00)</option><option>Toutes les X heures</option><option>Toutes les X minutes (TEST)</option></select> <!> <!> <button class="button warning metro-btn" type="button"><span class="mif-calendar"></span> Programmer</button> <button class="button success metro-btn" type="button" style="margin-left:10px;" title="Lancer immédiatement l'envoi pour l'utilisateur connecté"><span class="mif-rocket"></span> Lancer maintenant</button> <!></div> <span class="status-msg"> <!></span></div></div> <div class="mt-2 center"><button class="button secondary metro-btn" type="button"><span class="mif-file-text"></span> Voir le dernier rapport généré</button></div> <!></div> <div id="emailDialog" data-role="dialog" data-close-button="true" data-overlay="true" data-width="400"><div class="dialog-title">Envoyer le rapport par email</div> <div class="dialog-content"><label for="emailInput">Adresse email destinataire</label> <input id="emailInput" type="email" class="input" style="width:96%" required/> <span style="font-size:0.95em;"> </span></div> <div class="dialog-actions"><button class="button success">Envoyer</button> <button class="button">Annuler</button></div></div>`,1);function $n(a,i){Pr(i,!1);let r=A(!1),s=A(""),l=!1;typeof window<"u"&&(l=window.location.hostname==="localhost"||window.location.hostname.startsWith("127.")||window.location.hostname.endsWith(".local"));const c="/proxy-gmail.php";function u(n){return l?`${c}/${n}`:`${c}?action=${n}`}let y=A(!1),E="",p=A(!0),w=A(""),D=A(""),h=A(""),O=A(!0),x=A(!0),_=A(!1),N=A(0),Z=A(""),H=A(new Date().toISOString().slice(0,10)),R=A(""),V=A(""),q=A(null),re=A(!1),K=A(""),te=A(!1),W=A(""),oe=A(""),me=A(null);function _e(){window.Metro&&window.Metro.charms&&e(me)&&window.Metro.charms.toggle(e(me))}let be=A(!1),ne=A("..."),J=A(""),se=A("1"),le=A("1"),he=A(""),Le=A(!1),Me=A(""),we=A(!1),ve=A(!1);Ur(async()=>{const n=document.createElement("style");if(n.innerHTML=`
.activity-overlay {
  z-index: 9999 !important;
  position: fixed !important;
  top: 0;
  left: 0;
}
  `,document.head.appendChild(n),!document.querySelector('[data-role="activity"]')){const o=document.createElement("div");o.setAttribute("data-role","activity"),document.body.appendChild(o)}(await sr(async()=>{const{default:o}=await import("../chunks/BxdCQJyt.js").then(v=>v.h);return{default:o}},__vite__mapDeps([0,1,2]),import.meta.url)).default,await Da(),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&Oa()})});async function Da(){t(p,!0),t(w,"connexion"),await Oa()}async function Oa(){try{const o=await(await fetch(u("auth-url"),{credentials:"include"})).json();o.email?(t(ne,o.email),t(ve,!0),t(h,""),E="",t(p,!1),t(w,""),t(D,""),await Ot(),ge()):(t(ne,""),t(ve,!1),t(h,o.url),E="",t(p,!0),t(w,"connexion"),t(D,"Connexion à Gmail requise"))}catch{t(ne,""),t(ve,!1),t(h,""),E="Erreur de connexion à Gmail",t(p,!0),t(w,"connexion"),t(D,"Erreur de connexion à Gmail")}console.log({isConnected:e(ve),blocageUI:e(p),mainUserEmail:e(ne),authUrl:e(h)})}async function Et(){t(R,"Déconnexion en cours…");try{(await(await fetch(l?"http://localhost:4000/logout":"/proxy-gmail.php?action=logout",{method:"POST",credentials:"include"})).json()).success?(t(R,"Déconnexion réussie. Vous pouvez maintenant vous reconnecter."),setTimeout(()=>{t(ve,!1),t(ne,""),t(p,!0),t(w,"connexion"),t(h,""),t(R,""),Da()},2200)):t(R,"Échec de la déconnexion.")}catch{t(R,"Erreur réseau lors de la déconnexion.")}}let ie=A("idle");async function kt(){if(e(p)||e(_))return;t(_,!0),t(p,!0),t(w,"generation"),t(ie,"loading"),t(Z,"Génération du rapport..."),t(N,0);let n="";t(r,!1),t(V,"");try{const o=await fetch(u("generate-report"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:e(H),onlyUnread:e(O),groupByLabel:e(x)})});let v;const b=o.headers.get("content-type");if(b&&b.includes("application/json"))v=await o.json(),t(V,v.reportUrl);else{const S=await o.text();throw console.error("Réponse inattendue (HTML ?):",S),new Error("Erreur serveur: "+S)}if(!v.success||!v.jobId)throw t(ie,"error"),t(Z,"Erreur lors du lancement du rapport"),new Error("JobID manquant");n=v.jobId;let k=!1;for(;!k;){await new Promise(U=>setTimeout(U,1e3));const C=await(await fetch(u("get-report-progress")+(l?`?jobId=${n}`:""),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:n})})).json();t(N,Number(C.progress||0)),C.progress>=100&&(k=!0,t(ie,"success"),t(Z,"Rapport généré avec succès !"),t(s,JSON.stringify({date:e(H),onlyUnread:e(O),groupByLabel:e(x)})),t(r,!0),Ra())}}catch(o){t(ie,"error"),t(Z,"Erreur lors de la génération: "+(o instanceof Error?o.message:o))}finally{t(_,!1),t(p,!1),t(w,""),t(N,100)}}async function At(){t(q,null),t(K,""),t(re,!0);try{if(!e(H)){t(re,!1);return}const n=new URLSearchParams({date:e(H),onlyUnread:e(O)?"true":"false"}),v=await(await fetch(u("count-emails")+(l?`?${n}`:""),{credentials:"include"})).json();typeof v.count=="number"?(t(q,v.count),t(K,"")):(t(q,null),t(K,"Erreur de comptage"))}catch{t(q,null),t(K,"Erreur de comptage")}finally{await Hr(),t(re,!1)}}async function Ra(){t(W,""),t(oe,"");try{const o=await(await fetch(u("last-report"),{credentials:"include"})).json();o.html?t(W,o.html):t(oe,"Aucun rapport généré")}catch{t(oe,"Erreur lors du chargement du rapport")}}async function St(){if(!(e(p)||e(_)||e(Le))){t(Le,!0),t(Me,"Lancement…");try{const n=await fetch(u("automation/run-now"),{method:"POST",credentials:"include"}),o=await n.json();if(!n.ok||!o?.ok)throw new Error(o?.error||"Échec du lancement");t(r,!0);const v=c;t(V,l?`${v}/show-report/${o.token}`:`${v}?action=show-report/${o.token}`),t(Me,`✅ Email envoyé (${o.count??0} mails).`),window.Metro&&window.Metro.toast&&window.Metro.toast.create("✅ Automatisation lancée — rapport envoyé",null,3e3,"success")}catch(n){const o=n instanceof Error?n.message:String(n);t(Me,"❌ Erreur: "+o),window.Metro&&window.Metro.toast&&window.Metro.toast.create("❌ Erreur lors du lancement automatique",null,4e3,"alert")}finally{t(Le,!1)}}}async function Ia(){try{if((await fetch(u("enable-automation"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({active:!1})})).status===401){window.Metro&&window.Metro.toast&&window.Metro.toast.create("Session expirée — veuillez vous reconnecter",null,4e3,"alert");return}t(we,!1),t(J,""),t(se,"1"),t(le,"1"),t(he,"⏹ Automatisation désactivée"),ge(),window.Metro&&window.Metro.toast&&window.Metro.toast.create("⏹ Automatisation désactivée",null,3e3,"alert")}catch(n){console.error("❌ Erreur désactivation automatisation:",n),window.Metro&&window.Metro.toast&&window.Metro.toast.create("❌ Erreur lors de la désactivation",null,4e3,"alert")}}async function Mt(){t(he,"Enregistrement en cours...");let n=null;e(J)==="daily"?n=1440:e(J)==="xhours"?n=parseInt(e(se)||"1")*60:e(J)==="xminutes"&&(n=parseInt(e(le)||"1"));const o=e(J);if(o===""||o==="none"||!n||n<=0)return Ia();const v={frequency:e(J),xhours:e(se),xminutes:e(le),frequencyMinutes:n};try{const b=await fetch(u("enable-automation"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(v)}),k=await b.text();console.log("Réponse backend:",k),b.ok?(ge(),t(we,!0),window.Metro&&window.Metro.toast&&window.Metro.toast.create("✅ Automatisation activée",null,3e3,"success")):t(he,"Erreur lors de l’enregistrement")}catch{t(he,"Erreur réseau")}}let de=A(""),xe=A(e(ne));async function Tt(){if(!/^[^@]+@[^@]+\.[^@]+$/.test(e(xe))){t(de,"Adresse invalide.");return}t(de,"Envoi…");let n="";try{n=(await(await fetch(u("last-report"),{credentials:"include"})).json()).html}catch{t(de,"Impossible de récupérer le rapport.");return}try{const v=await(await fetch(u("send-report"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:e(xe),subject:`Résumé Gmail du ${e(H)}`,html:n})})).json();v.success?(t(de,"Rapport envoyé à "+e(xe)),setTimeout(()=>{t(be,!1),t(de,""),window.Metro&&window.Metro.dialog&&window.Metro.dialog.close("#emailDialog")},1200)):t(de,"Erreur lors de l’envoi : "+(v.error||""))}catch{t(de,"Erreur réseau lors de l’envoi.")}}async function Dt(){if(!e(W)){alert("Aucun rapport disponible.");return}const n=document.createElement("div");n.className="activity-overlay metro-activity",n.style.cssText=`
			position: fixed;
			top: 0; left: 0;
			width: 100vw;
			height: 100vh;
			background-color: rgba(255, 255, 255, 0.8);
			z-index: 9999;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2em;
			font-weight: bold;
			color: #34495e;
		`,n.innerHTML=`
			<style>
				@keyframes spin {
					0% { transform: rotate(0deg); }
					100% { transform: rotate(360deg); }
				}
			</style>
			<div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
				<div style="
					border: 6px solid #f3f3f3;
					border-top: 6px solid #3498db;
					border-radius: 50%;
					width: 48px;
					height: 48px;
					animation: spin 1s linear infinite;
				"></div>
				<div style="font-size:1.1em;">Génération du PDF en cours, patientez ...</div>
			</div>
		`,document.body.appendChild(n);try{const v=await(await fetch(u("last-report"),{credentials:"include"})).json();if(!v||!v.json||!v.html){alert("Données de rapport incomplètes.");const T=document.querySelector(".activity-overlay");T&&T.remove();return}let b=[];const k=v.json;if(Array.isArray(k))b=k;else if(typeof k=="object"&&k!==null)b=Object.values(k).flat();else{alert("Format des emails inconnu ou invalide.");const T=document.querySelector(".activity-overlay");T&&T.remove();return}const S=await fetch(u("report-pdf"),{method:"GET",credentials:"include"});if(!S.ok){alert("Erreur lors de la génération du PDF.");const T=document.querySelector(".activity-overlay");T&&T.remove();return}const C=await S.blob(),U=URL.createObjectURL(C),M=document.createElement("a");M.href=U,M.download=`rapport-gmail-${new Date().toISOString().slice(0,10)}.pdf`,M.click();const $=document.querySelector(".activity-overlay");$&&$.remove(),URL.revokeObjectURL(U)}catch(o){console.error("Erreur export PDF serveur:",o);const v=document.querySelector(".activity-overlay");v&&v.remove(),alert("Erreur réseau ou serveur lors de l'export PDF.")}}async function Ot(){try{const o=await(await fetch(u("get-automation"),{credentials:"include"})).json();o.active?(t(J,o.frequency||""),t(se,o.xhours||"1"),t(le,o.xminutes||"1"),t(we,!0),ge()):(t(we,!1),t(J,""),t(se,"1"),t(le,"1"),ge())}catch{console.warn("Erreur chargement automation"),t(we,!1),t(J,""),t(se,"1"),t(le,"1"),ge()}}function Rt(){t(be,!0),t(xe,e(ne)),t(de,""),setTimeout(()=>{window.Metro&&window.Metro.dialog&&window.Metro.dialog.open("#emailDialog")},0)}function ge(){t(he,e(J)?e(J)==="daily"?"Automatisation quotidienne activée (07h00)":e(J)==="xhours"?`Automatisation toutes les ${e(se)} heures`:e(J)==="xminutes"?`Automatisation toutes les ${e(le)} min`:"Aucune automatisation active":"Aucune automatisation active")}ot(()=>(e(H),e(O),e(x),e(s)),()=>{const n=JSON.stringify({date:e(H),onlyUnread:e(O),groupByLabel:e(x)});e(s)&&n!==e(s)&&t(r,!1)}),ot(()=>(e(ve),e(H),e(p),e(O)),()=>{e(ve)&&e(H)&&!e(p)&&e(O)!==void 0&&At()}),Gr(),lr();var Ca=qn(),La=X(Ca);{var It=n=>{var o=ln(),v=f(o),b=f(v),k=m(f(b),3),S=f(k);{var C=T=>{var F=on(),P=f(F);d(F),z(()=>B(P,`Erreur : ${e(D)??""}`)),g(T,F)},U=T=>{var F=st("Merci de vous connecter pour utiliser l’application");g(T,F)};L(S,T=>{e(w)==="erreur"?T(C):T(U,!1)})}d(k);var M=m(k,2);{var $=T=>{var F=sn(),P=f(F);d(F),z(()=>Ce(P,"href",e(h))),Y("click",P,()=>{t(y,!0)}),g(T,F)};L(M,T=>{e(h)&&T($)})}d(b),d(v),d(o),g(n,o)};L(La,n=>{e(ve)||n(It)})}var Na=m(La,2);L(Na,n=>{});var Ne=m(Na,4);let ja;var qa=f(Ne);{var Ct=n=>{var o=ce(),v=X(o);{var b=S=>{},k=S=>{var C=dn(),U=f(C),M=m(f(U),2),$=f(M);{var T=P=>{var j=st("Connexion à Gmail en cours...");g(P,j)},F=P=>{var j=ce(),G=X(j);{var ee=ae=>{var pe=cn(),ze=m(X(pe),2),pa=f(ze);d(ze),z(()=>B(pa,`${e(N)??""}%`)),g(ae,pe)},fe=ae=>{var pe=ce(),ze=X(pe);{var pa=ke=>{var De=un(),or=f(De);d(De),z(()=>B(or,`Erreur : ${e(D)??""}`)),g(ke,De)},ir=ke=>{var De=vn();g(ke,De)};L(ze,ke=>{e(w)==="erreur"?ke(pa):ke(ir,!1)},!0)}g(ae,pe)};L(G,ae=>{e(w)==="generation"?ae(ee):ae(fe,!1)},!0)}g(P,j)};L($,P=>{e(w)==="connexion"?P(T):P(F,!1)})}d(M),d(U),d(C),g(S,C)};L(v,S=>{e(w)==="connexion"&&!e(y)?S(b):S(k,!1)})}g(n,o)};L(qa,n=>{e(p)&&n(Ct)})}var Fe=m(qa,2),Pa=f(Fe),Be=m(Pa,2),Ua=f(Be),Lt=m(f(Ua));{var Nt=n=>{var o=fn(),v=f(o);d(o),z(()=>B(v,`(${e(ne)??""})`)),g(n,o)};L(Lt,n=>{e(ne)&&n(Nt)})}d(Ua),$r(2),d(Be);var jt=m(Be,2);{var qt=n=>{var o=hn(),v=X(o),b=m(v,2);{var k=S=>{var C=_n(),U=f(C),M=f(U),$=f(M);{var T=j=>{var G=pn();g(j,G)},F=j=>{var G=ce(),ee=X(G);{var fe=ae=>{var pe=mn();g(ae,pe)};L(ee,ae=>{e(R),Se(()=>e(R).startsWith("Déconnexion réussie"))&&ae(fe)},!0)}g(j,G)};L($,j=>{e(R)==="Déconnexion en cours…"?j(T):j(F,!1)})}var P=m($);d(M),d(U),d(C),z(()=>B(P,` ${e(R)??""}`)),g(S,C)};L(b,S=>{e(R)&&S(k)})}z(()=>v.disabled=e(R)==="Déconnexion en cours…"),Y("click",v,Et),g(n,o)};L(jt,n=>{e(ve)&&n(qt)})}d(Fe);var Te=m(Fe,2);let Ga;var Je=f(Te),je=m(f(Je),2);$e(je),d(Je);var Ve=m(Je,2),Pt=f(Ve);{var Ut=n=>{var o=gn();g(n,o)},Gt=n=>{var o=ce(),v=X(o);{var b=S=>{var C=yn(),U=f(C,!0);d(C),z(()=>B(U,e(K))),g(S,C)},k=S=>{var C=ce(),U=X(C);{var M=$=>{var T=ce(),F=X(T);{var P=G=>{var ee=bn();g(G,ee)},j=G=>{var ee=wn(),fe=f(ee);d(ee),z(ae=>B(fe,`${ae??""} mails récupérables / ${e(q)??""} trouvés`),[()=>(e(q),Se(()=>Math.min(e(q),50)))]),g(G,ee)};L(F,G=>{e(q)===0?G(P):G(j,!1)})}g($,T)};L(U,$=>{e(q)!==null&&$(M)},!0)}g(S,C)};L(v,S=>{e(K)?S(b):S(k,!1)},!0)}g(n,o)};L(Pt,n=>{e(re)?n(Ut):n(Gt,!1)})}d(Ve);var za=m(Ve,2),We=m(f(za),2),Xe=f(We),$a=f(Xe),qe=f($a);$e(qe);var Ye=m(qe,4),zt=f(Ye,!0);d(Ye),d($a),d(Xe);var Ha=m(Xe,2),Fa=f(Ha),Pe=f(Fa);$e(Pe);var Ke=m(Pe,4),$t=f(Ke,!0);d(Ke),d(Fa),d(Ha),d(We);var Qe=m(We,2),Ze=f(Qe),ea=f(Ze),Ht=m(f(ea));d(ea),d(Ze);var Ba=m(Ze,2),Ue=f(Ba),Ft=m(f(Ue));d(Ue),d(Ba),d(Qe);var aa=m(Qe,2),Bt=f(aa);{var Jt=n=>{var o=Sn(),v=f(o),b=f(v),k=f(b);{var S=U=>{var M=En(),$=m(X(M)),T=m($);{var F=P=>{var j=xn(),G=m(X(j)),ee=f(G);d(G),z(()=>B(ee,`${e(N)??""}%`)),g(P,j)};L(T,P=>{e(_)&&P(F)})}z(()=>B($,` ${e(Z)??""} `)),g(U,M)},C=U=>{var M=ce(),$=X(M);{var T=P=>{var j=kn(),G=m(X(j));z(()=>B(G,` ${e(Z)??""}`)),g(P,j)},F=P=>{var j=ce(),G=X(j);{var ee=fe=>{var ae=An(),pe=m(X(ae));z(()=>B(pe,` ${e(Z)??""}`)),g(fe,ae)};L(G,fe=>{e(ie)==="error"&&fe(ee)},!0)}g(P,j)};L($,P=>{e(ie)==="success"?P(T):P(F,!1)},!0)}g(U,M)};L(k,U=>{e(ie)==="loading"?U(S):U(C,!1)})}d(b),d(v),d(o),z(()=>{Oe(o,`background:${e(ie)==="error"?"#ffeaea":"#e8fff2"}; padding:10px;`),Oe(b,`font-size:1.13em; margin-right:16px; color:
          ${e(ie)==="error"?"#c0392b":e(ie)==="success"?"#249656":"green"};
          white-space: nowrap;
          flex: 1;`)}),g(n,o)};L(Bt,n=>{e(ie)!=="idle"&&n(Jt)})}d(aa);var Vt=m(aa,2);{var Wt=n=>{var o=Mn(),v=f(o);d(o),z(()=>Ce(v,"href",e(V))),g(n,o)};L(Vt,n=>{e(V)&&n(Wt)})}d(za),d(Te);var ta=m(Te,2),Ja=f(ta),ra=m(f(Ja),2),Xt=f(ra,!0);d(ra);var na=m(ra,2),Ee=f(na);z(()=>{e(J),ha(()=>{e(p),e(_)})});var ia=f(Ee);ia.value=ia.__value="";var oa=m(ia);oa.value=oa.__value="daily";var sa=m(oa);sa.value=sa.__value="xhours";var Va=m(sa);Va.value=Va.__value="xminutes",d(Ee);var Wa=m(Ee,2);{var Yt=n=>{var o=Dn();z(()=>{e(se),ha(()=>{e(p),e(_)})}),Jr(o,4,()=>Se(()=>Array(12).fill(0).map((v,b)=>b+1)),Fr,(v,b)=>{var k=Tn(),S=f(k);d(k);var C={};z(()=>{B(S,`${b??""}h`),C!==(C=b)&&(k.value=(k.__value=b)??"")}),g(v,k)}),d(o),z(()=>o.disabled=e(p)||e(_)),wa(o,()=>e(se),v=>t(se,v)),g(n,o)};L(Wa,n=>{e(J)==="xhours"&&n(Yt)})}var Xa=m(Wa,2);{var Kt=n=>{var o=On();z(()=>{e(le),ha(()=>{e(p),e(_)})});var v=f(o);v.value=v.__value="1";var b=m(v);b.value=b.__value="5";var k=m(b);k.value=k.__value="10";var S=m(k);S.value=S.__value="15";var C=m(S);C.value=C.__value="30",d(o),z(()=>o.disabled=e(p)||e(_)),wa(o,()=>e(le),U=>t(le,U)),g(n,o)};L(Xa,n=>{e(J)==="xminutes"&&n(Kt)})}var la=m(Xa,2),ca=m(la,2),Qt=m(ca,2);{var Zt=n=>{var o=Rn();Y("click",o,Ia),g(n,o)};L(Qt,n=>{e(we)&&n(Zt)})}d(na);var Ya=m(na,2),Ka=f(Ya),er=m(Ka);{var ar=n=>{var o=In(),v=m(X(o)),b=f(v,!0);d(v),z(()=>B(b,e(Me))),g(n,o)};L(er,n=>{e(Me)&&n(ar)})}d(Ya),d(Ja),d(ta);var ua=m(ta,2),Qa=f(ua);d(ua);var tr=m(ua,2);{var rr=n=>{var o=jn(),v=f(o),b=f(v),k=m(b,4),S=m(k,2);{var C=M=>{var $=Cn(),T=f($,!0);d($),z(()=>B(T,e(oe))),g(M,$)},U=M=>{var $=ce(),T=X($);{var F=j=>{var G=Ln(),ee=f(G);Wr(ee,()=>e(W)),d(G),g(j,G)},P=j=>{var G=Nn();g(j,G)};L(T,j=>{e(W)?j(F):j(P,!1)},!0)}g(M,$)};L(S,M=>{e(oe)?M(C):M(U,!1)})}d(v),d(o),z(()=>k.disabled=!e(W)),Y("click",b,()=>t(te,!1)),Y("click",k,Dt),Y("click",v,tn(function(M){nn.call(this,i,M)})),Y("keydown",v,M=>{M.key==="Escape"&&t(te,!1)}),Y("click",o,()=>t(te,!1)),Y("keydown",o,M=>{(M.key==="Escape"||M.key==="Enter"||M.key===" ")&&t(te,!1)}),g(n,o)};L(tr,n=>{e(te)&&n(rr)})}d(Ne);var va=m(Ne,2);let Za;var da=m(f(va),2),Ge=m(f(da),2);$e(Ge);var et=m(Ge,2),nr=f(et,!0);d(et),d(da);var at=m(da,2),fa=f(at),tt=m(fa,2);d(at),d(va),z((n,o,v,b)=>{ja=ut(Ne,1,"metro-container",null,ja,n),Ga=ut(Te,1,"svelte-10mpwr2",null,Ga,o),Ce(je,"max",v),je.disabled=e(p)||e(_),qe.disabled=e(p)||e(_),Oe(Ye,`color:${e(O)?"#27ae60":"#c0392b"};`),B(zt,e(O)?"mails: que les non lus":"mails: lus et non lus"),Pe.disabled=e(p)||e(_),Oe(Ke,`color:${e(x)?"#27ae60":"#c0392b"};`),B($t,e(x)?"groupé par label":"non groupé par label"),ea.disabled=e(_)||e(p),B(Ht,` ${e(_)?"Génération en cours...":"Générer le rapport"}`),Ue.disabled=e(p)||e(_)||!e(r),B(Ft,` ${e(_)?"Envoi en cours...":"Envoyer par mail"}`),B(Xt,e(he)),Ee.disabled=e(p)||e(_),la.disabled=e(p)||e(_),ca.disabled=e(p)||e(_)||e(Le),B(Ka,`${e(he)??""} `),Qa.disabled=e(p)||e(_)||!e(r),Za=Oe(va,"",Za,b),Ge.disabled=e(p)||e(_),B(nr,e(de)),fa.disabled=e(p)||e(_),tt.disabled=e(p)||e(_)},[()=>({blocked:e(p)}),()=>({"form-disabled":e(p)}),()=>Se(()=>new Date().toISOString().slice(0,10)),()=>({display:e(be)?"block":"none"})]),Y("click",Pa,_e),dt(je,()=>e(H),n=>t(H,n)),ft(qe,()=>e(O),n=>t(O,n)),ft(Pe,()=>e(x),n=>t(x,n)),Y("click",Ue,Rt),Y("submit",Te,rn(kt)),wa(Ee,()=>e(J),n=>t(J,n)),Y("change",Ee,ge),Y("click",la,Mt),Y("click",ca,St),Y("click",Qa,()=>{t(te,!0),Ra()}),dt(Ge,()=>e(xe),n=>t(xe,n)),Y("click",fa,Tt),Y("click",tt,()=>{t(be,!1),window.Metro&&window.Metro.dialog.close("#emailDialog")}),g(a,Ca),zr()}export{$n as component};
